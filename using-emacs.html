<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2025-12-15 Mon 17:20 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Working inside emacs</title>
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/readtheorg.css"/>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/code-copy.css"/>
<link rel="stylesheet" type="text/css" href="src/readtheorg_theme/css/search.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/js/search.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/js/readtheorg.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/js/code-copy.js"></script>
</head>
<body>
<div id="content" class="content">
<h1 class="title">Working inside emacs</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org357cb0c">1. Emacs tab</a></li>
<li><a href="#orga2a0f03">2. Merge my linux and mac configuration</a></li>
<li><a href="#org24357ce">3. Set transparent background</a></li>
<li><a href="#orgd56df64">4. Set up emacs to load pkgs installed from nix</a>
<ul>
<li><a href="#orga4478ff">4.1. First solution [deprecated]</a></li>
<li><a href="#org9a43acd">4.2. Second solution</a></li>
<li><a href="#org83b0d9f">4.3. Third solution</a></li>
</ul>
</li>
<li><a href="#org49549bc">5. How to code per file</a></li>
<li><a href="#org24ac320">6. How to scroll inside vterm</a></li>
<li><a href="#org7888dad">7. How to find then filter down and replace in emacs</a></li>
<li><a href="#org9409116">8. Setting compilation environment variable</a></li>
<li><a href="#org835775b">9. Working with macros</a>
<ul>
<li><a href="#org4019198">9.1. Executing macros with variations</a></li>
<li><a href="#org79c5f37">9.2. Editing macros interactively</a></li>
<li><a href="#orgb7eb927">9.3. Reorganizing macros</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-org357cb0c" class="outline-2">
<h2 id="org357cb0c"><span class="section-number-2">1.</span> Emacs tab</h2>
<div class="outline-text-2" id="text-1">
<blockquote>
<p>
How I manually insert tabs inside emacs ?
</p>
</blockquote>

<p>
Emacs prevents inserting tabs, I think it's because the key is bound to complete when you set the variable <code>indent-tabs-mode</code> to nil.
</p>

<blockquote>
<p>
Why would you set this variable to nil ?
</p>
</blockquote>

<p>
This variable permit to complete inside minibuffer or the buffer when you type tab, it's pretty handy as its the default that people are used to from other editors.
</p>


<blockquote>
<p>
How to then manually insert your tabs ?
</p>
</blockquote>

<p>
You can use the key sequence <code>C-q &lt;tab&gt;</code> to insert a tab, but electric-mode will cause you some ugly indentation for the next lines.
</p>

<p>
The second solution is to use the interactive function <code>tab-to-tab-stop</code>. It permit to go to the next tab-stop.
</p>

<p>
I bound this function to the key <code>C-&lt;tab&gt;</code> so that I can quickly insert tabs wherever I want :   <code>(global-set-key (kbd "C-&lt;tab&gt;") 'tab-to-tab-stop)</code>
</p>
</div>
</div>
<div id="outline-container-orga2a0f03" class="outline-2">
<h2 id="orga2a0f03"><span class="section-number-2">2.</span> Merge my linux and mac configuration</h2>
<div class="outline-text-2" id="text-2">
<blockquote>
<p>
How to execute a elisp bloc depending on whether you're on mac or linux ?
</p>
</blockquote>


<p>
The variable <code>system-type</code> is set to your current system.
</p>

<p>
<code>darwin</code> for macos and <code>gnu/linux</code> for linux.
</p>

<p>
You just have to use a condition depending on what you want to execute on the current system.
</p>

<p>
Example :
</p>

<pre class="example" id="org99f3eaa">
(cond
 ((eq system-type 'darwin)  ;; macOS
  (setq read-process-output-max (* 64 1024)))  ;; 64KB
 ((eq system-type 'gnu/linux)  ;; Linux
  (setq read-process-output-max (* 1024 1024)))  ;; 1MB
 )
</pre>


<blockquote>
<p>
Do not forget variable like <code>user-emacs-directory</code> that helps you and diminishes the use of the conditional statements.
</p>
</blockquote>
</div>
</div>
<div id="outline-container-org24357ce" class="outline-2">
<h2 id="org24357ce"><span class="section-number-2">3.</span> Set transparent background</h2>
<div class="outline-text-2" id="text-3">
<blockquote>
<p>
How to set transparent background in emacs ?
</p>
</blockquote>


<p>
To set transparent background in emacs, there are two methods, only one works for each systems (in my experience).
</p>

<p>
On linux, what worked for me :
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>(set-frame-parameter nil 'alpha-background 60)
(add-to-list 'default-frame-alist '(alpha-background . 60))
</code></pre>
</div>

<p>
On mac, what worked :
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>(set-frame-parameter (selected-frame) 'alpha '(92 . 50))
(add-to-list 'default-frame-alist '(alpha . (92 . 50))))
</code></pre>
</div>
</div>
</div>
<div id="outline-container-orgd56df64" class="outline-2">
<h2 id="orgd56df64"><span class="section-number-2">4.</span> Set up emacs to load pkgs installed from nix</h2>
<div class="outline-text-2" id="text-4">
<blockquote>
<p>
How to load the packages that you installed from nix inside emacs ?
</p>

<p>
We're not talking about binaries, but emacs packages. Such packages should not make modification to any path, unless you want an impure environment.
</p>
</blockquote>
</div>
<div id="outline-container-orga4478ff" class="outline-3">
<h3 id="orga4478ff"><span class="section-number-3">4.1.</span> First solution [deprecated]</h3>
<div class="outline-text-3" id="text-4-1">
<p>
The first solution, which is the simplest, is to just open a devshell, in which you've installed and initialize the emacs packages. An example for julia environment
</p>


<div class="org-src-container">
<pre class="src src-nix"><code>{
  description = "Environment to code in Julia";

  inputs = {
    nixpkgs.url = "github:nixos/nixpkgs?ref=nixos-unstable";
    flake-utils.url = "github:numtide/flake-utils";
  };

  outputs = { self, nixpkgs, flake-utils }:
    flake-utils.lib.eachDefaultSystem (system:
      let 
        pkgs = import nixpkgs { inherit system; };
      in {
        devShell = pkgs.mkShell {
          nativeBuildInputs = with pkgs; [
            julia-bin
            emacsPackages.julia-ts-mode
            bc
          ];

          shellHook = ''
            julia -e 'import Pkg; Pkg.add("DebugAdapter")' \
            julia -e 'import Pkg; Pkg.add("LanguageServer")' \
            emacs --batch --eval "(progn (package-initialize))" \
            echo "My julia environment for coding"
          '';
        };
      }
    );
}
</code></pre>
</div>

<p>
The packages should be present and loaded after your run `emacs &amp;` in the dev shell.
</p>
</div>
</div>
<div id="outline-container-org9a43acd" class="outline-3">
<h3 id="org9a43acd"><span class="section-number-3">4.2.</span> Second solution</h3>
<div class="outline-text-3" id="text-4-2">
<blockquote>
<p>
Why bother with this second solution ?
</p>

<p>
While building the dev environment using nix, the first solution demands to quit emacs, make your changes and reload emacs to check if all is correctly setup. That was such a pain that I decided to find a solution. (I hate doing the same things in repitition)
</p>
</blockquote>


<p>
The second solution involves using packages like <code>envrc</code> (the one I use) or <code>direnv</code> (an alternative).
</p>

<p>
I use <a href="https://github.com/purcell/envrc">envrc</a> becauses it loaded the variables from direnv at a buffer level instead of inserting them to emacs global state.
</p>

<p>
My configuration looks like :
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>(use-package envrc
    :config
    (envrc-global-mode))
</code></pre>
</div>


<p>
For this to work, you should have the direnv binary, an <code>.envrc</code> file inside your root dir, and had allowed direnv to automatically load your shell environment. Details here :  <a href="https://nix.dev/guides/recipes/direnv.html">nix direnv workflow</a> and <a href="https://direnv.net/">direnv documentation</a>
</p>

<p>
The fact is, with this method, the binary will be inside the path of emacs and you'll be able to use them, but not the emacsPackages, because the load-path will not gets populate with those packages root directories.
</p>

<p>
The workaround I found for this is to add those directories to the load path with some elisp code. Here is my custom function that does that :
</p>


<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>(defun smv/add-nix-pkg-to-lpath (PKG_ENV)
    "Load the PKG_ENV directory to the load path of current emacs session
    it permits to then require the package"

    (let ((pkg-nix-path (getenv PKG_ENV)))

      (unless pkg-nix-path
        (user-error "Environment variable '%s' is not set" PKG_ENV))

      (let ((pkg-suffix "/share/emacs/site-lisp/elpa/"))

        (string-match "-emacs-\\([^/]+\\)" pkg-nix-path)

        (let* ((pkg-full-path (match-string 1 pkg-nix-path))
               (path-to-add (concat pkg-nix-path pkg-suffix pkg-full-path)))
          (unless (member path-to-add load-path)
            (add-to-list 'load-path path-to-add))))))
</code></pre>
</div>


<p>
Depending on some environment variable it add the "/share/emacs/site-elisp/elpa/&lt;package-name&gt;" directory of this environment variable to the load path.
</p>

<p>
The required environment variable here is the nix-path of the package you want to load.
</p>

<p>
How I use it ?
</p>

<div class="org-src-container">
<pre class="src src-nix"><code>{
  ...
        devShell = pkgs.mkShell {
          nativeBuildInputs = with pkgs; [
            julia-bin
            emacsPackages.julia-ts-mode
            bc
          ];

          shellHook = ''
            export EMACS_JULIATS = "${pkgs.emacsPackages.julia-ts-mode}"
            echo "My julia environment for coding"
          '';
        };

   ...
}
</code></pre>
</div>

<p>
Look at the <code>shellHook</code> bloc, I've defined a shell environment variable that will be buffer available when envrc will run direnv.
</p>

<p>
Then you can call my custom function using this variable as an argument. For example :
</p>

<p>
<code>(smv/add-nix-pkg-to-lpath EMACS_JULIATS)</code>
</p>

<p>
You can add such call to your .dir-locals.el file inside the root directory of your project and that's it.
</p>
</div>
</div>
<div id="outline-container-org83b0d9f" class="outline-3">
<h3 id="org83b0d9f"><span class="section-number-3">4.3.</span> Third solution</h3>
<div class="outline-text-3" id="text-4-3">
<p>
The last solution involves <a href="https://www.jetify.com/docs/devbox/installing-devbox">devbox</a>, it's a wrapper around nix that you could use without knowing the nix language. It's pretty cool if you only use nix as an dev environment manager.
</p>

<p>
After the initialization of devbox in your project, you should generate the direnv file : <a href="https://www.jetify.com/docs/devbox/ide-configuration/direnv">generate direnv</a>
</p>

<p>
The approach here will be to take advantage of the environment variable <a href="https://emacsdocs.org/docs/elisp/Library-Search">EMACSLOADPATH</a>. This variable is used to build the load-path at emacs' start.
</p>

<p>
I wrote this script that you could add to your devbox init<sub>hook</sub>, such that it's ran when you enter the shell.
</p>

<div class="org-src-container">
<pre class="src src-shell"><code>EMACS_LOAD_PATHS=''
for pkg in $(printenv buildInputs | tr ' ' '\\n' | grep -E 'emacs.*-mode');
do
    PKG_NAME=$(basename $pkg | awk -F- '{ printf "%s-%s", $3, $4 }')
    PKG_VERSION=$(devbox info emacsPackages.$PKG_NAME 2&gt;/dev/null | awk '{print $2}' || echo '')
    if [ -n "$PKG_VERSION" ]; then
        EMACS_LOAD_PATHS="$pkg/share/emacs/site-lisp/elpa/$PKG_NAME-$PKG_VERSION:$EMACS_LOAD_PATHS"
    fi
done
export EMACSLOADPATH="$EMACS_LOAD_PATHS$EMACSLOADPATH"
echo "âœ“ Emacs packages loaded"
</code></pre>
</div>

<p>
To be able to do that in the most efficient way, what I've done, is just to create a new snippet that contains this code snippet.
</p>

<p>
This command will go through the packages that you've added and add the emacs' ones to the environment variable EMACSLOADPATH.
</p>

<p>
At this point of time running emacs in the devshell created by devbox should permit to get the emacs packages. We should now make it such that the same thing is done even in the current instance of emacs.
</p>

<p>
At the time of writing this I use <code>direnv-mode</code> now.
With direnv-mode, I can run the interactive command <code>direnv-update-environment</code> and that will run direnv and inject the variables into the emacs' global variables list.
So the thing to do is just to advice after this command. This will permit to add the paths to the load-path.
I've written this code snippet that you can add to your configuration :
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>(with-eval-after-load 'direnv
  (advice-add 'direnv-update-environment :after
              (lambda (&amp;rest _)
                (when (getenv "EMACSLOADPATH")
                  (let ((paths (split-string (getenv "EMACSLOADPATH") ":")))
                    (dolist (path (reverse paths))
                      (add-to-list 'load-path path)))))))
</code></pre>
</div>


<p>
And that is it. Running <code>direnv-update-environment</code> will also add the paths in EMACSLOADPATH to the current load-path of emacs.
</p>
</div>
</div>
</div>
<div id="outline-container-org49549bc" class="outline-2">
<h2 id="org49549bc"><span class="section-number-2">5.</span> How to code per file</h2>
<div class="outline-text-2" id="text-5">
<p>
This notes that I take requires me to modify my index.html file each time. I could've use a command to trigger the modification automatically. But the solution that came up first into my mind was to create a snippet that will only be available in that file. This way I can open my file add my new entry and that's it.
</p>

<p>
To execute some code on a directory level in emacs you could use a file called <code>.dir-locals.el</code>, to execute code in a per-file basis you use a <code>;; -*- eval: &lt;code&gt; ; -*-</code> on top of that file.
</p>

<p>
eval means evaluate, you could set others things, such as the mode, with <code>mode</code> like <code>mode: lisp</code> for example.
</p>

<p>
So here's what I wrote on top on my file, it uses the <code>auto-yasnippet</code>'s package variable <code>aya-current</code>  :
</p>

<p>
<code>;; -*- eval: (progn (setq aya-current "&lt;li&gt;&lt;a href=\"${1:org-file-name}.html\"&gt;${2:title}&lt;/a&gt;&lt;/li&gt;")); -*-</code>
</p>
</div>
</div>
<div id="outline-container-org24ac320" class="outline-2">
<h2 id="org24ac320"><span class="section-number-2">6.</span> How to scroll inside vterm</h2>
<div class="outline-text-2" id="text-6">
<p>
vterm has multiple mode, it's not like eshell that permits you to scroll without restriction inside the terminal.
</p>

<p>
In vterm, you should switch to the copy-mode to be able to scroll inside the terminal.
</p>

<p>
The default binding for that is : <code>C-c C-t</code>
</p>
</div>
</div>
<div id="outline-container-org7888dad" class="outline-2">
<h2 id="org7888dad"><span class="section-number-2">7.</span> How to find then filter down and replace in emacs</h2>
<div class="outline-text-2" id="text-7">
<p>
You can find patterns in folders in Emacs using `find-grep`, `find-grep-dired` (which will only show the file names inside a dired buffer), `rgrep`, and similar commands. All of these will open a grep buffer that utilizes `compilation-mode` bindings.
</p>

<blockquote>
<p>
How to filter the results and then perform replacements ?
</p>
</blockquote>

<p>
You can make the grep buffer read-only using `C-x C-q` (which runs `toggle-read-only`) and then use commands like `keep-lines` or `flush-lines` to filter the results. Alternatively, you can manually remove the lines you don't want from the list.
</p>

<p>
Once you have your desired selection, switch to `wgrep` mode (`wgrep-change-to-wgrep-mode`) to perform operations on the occurrences.
</p>
</div>
</div>
<div id="outline-container-org9409116" class="outline-2">
<h2 id="org9409116"><span class="section-number-2">8.</span> Setting compilation environment variable</h2>
<div class="outline-text-2" id="text-8">
<p>
When you're coding inside emacs you might want to run some commands using the project-compile command, which is really powerfull.
Sometimes you might want to set some compilation environment that is only needed during this command evaluation process, you don't need that variable outside. For example you might want to add some path to the PYTHONPATH for your project to correctly run.
</p>

<p>
To set those kind of commands, pay attention to the fact that using the "$PYTHONPATH" formula will not work. Prefer setting the environment by retrieving the variable value then add the new string to it.
</p>

<p>
What I mean is :
</p>

<p>
Prefer : <code>(setq compilation-environment (list (concat "PYTHONPATH=" (getenv "PYTHONPATH") ":" (expand-file-name "./src"))))</code> or <code>(setq compilation-environment (list (concat "PYTHONPATH=" (getenv "PYTHONPATH") ":./src")))</code>
</p>

<p>
instead of : <code>(setq compilation-environment '("PYTHONPATH=$PYTHONPATH:./src"))</code>
</p>
</div>
</div>
<div id="outline-container-org835775b" class="outline-2">
<h2 id="org835775b"><span class="section-number-2">9.</span> Working with macros</h2>
<div class="outline-text-2" id="text-9">
</div>
<div id="outline-container-org4019198" class="outline-3">
<h3 id="org4019198"><span class="section-number-3">9.1.</span> Executing macros with variations</h3>
<div class="outline-text-3" id="text-9-1">
<p>
While recording macros, you can use the command <code>C-x q</code> to stop at some point.
This command when you type it in the macro will not do anything but when you will play back the macro emacs will ask you wheter you want to continue the macro or not.
To this question you can answer <code>C-r</code> which will make emacs enter in a recursive edit mode where you can do things outside of the macro, like typing a particular piece of text.
After you've finished, you can type <code>C-M-c</code> to leave that recursive state and you will be prompted whether or not you want the macro to continue its execution.
</p>

<p>
<a href="https://www.gnu.org/software/emacs/manual/html_node/emacs/Keyboard-Macro-Query.html">The documentation for what I've explained</a>
</p>
</div>
</div>
<div id="outline-container-org79c5f37" class="outline-3">
<h3 id="org79c5f37"><span class="section-number-3">9.2.</span> Editing macros interactively</h3>
<div class="outline-text-3" id="text-9-2">
<p>
You can edit macros interactively, meaning while playing it.
The shortcut for that is : <code>C-x C-k SPC</code>
</p>

<p>
<a href="https://www.gnu.org/software/emacs/manual/html_node/emacs/Keyboard-Macro-Step_002dEdit.html">stepwise editing macros</a>
</p>
</div>
</div>
<div id="outline-container-orgb7eb927" class="outline-3">
<h3 id="orgb7eb927"><span class="section-number-3">9.3.</span> Reorganizing macros</h3>
<div class="outline-text-3" id="text-9-3">
<p>
You can reorganize the macros' kill ring.
Start by listing them with : <code>list-keyboard-macros</code> and here it's you can modify them
</p>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Created: 2025-12-15 Mon 17:20</p>
</div>
</body>
</html>
